machine:
  environment:
    PATH: "$PATH:~/$CIRCLE_PROJECT_REPONAME/bin"
  python:
    version: 2.7.9
  services:
    - docker
dependencies:
  post:
    - curl -L -o ~/bin/jq https://github.com/stedolan/jq/releases/download/jq-1.5rc1/jq-linux-x86_64-static && chmod +x ~/bin/jq
    - docker build --rm=false -t bellkev/circle-ecs:$CIRCLE_SHA1 . | cat # workaround progress weirdness
    - docker pull bellkev/nginx-base:stable | cat
test:
  override:
    - nosetests
    - docker run --name uwsgi bellkev/circle-ecs:$CIRCLE_SHA1:
        background: true
    - docker run --name nginx -p 8000:8000 --link uwsgi:uwsgi bellkev/nginx-base:stable:
        background: true
    - sleep 5
    - curl --retry 10 --retry-delay 5 localhost:8000 | grep "Hello"
deployment:
  prod:
    branch: master
    commands:
      - ./deploy.sh